<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>impact_model.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1667526-20']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <style type="text/css">
    td.docs h1 {
      margin-top: 0;
    }
    @media print {
      .code pre {
        white-space: pre-wrap;
      }
      .code {
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
      .code .highlight {
        margin-left: 15px;
        margin-right: 15px;
      }
    }
  </style>
</head>

<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>impact_model.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Copyright Â© 2010 Brighter Planet.
See LICENSE for details.
Contact Brighter Planet for dual-license arrangements.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;leap&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;timeframe&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;date&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;weighted_average&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;builder&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-ElectricityUse_carbon_model'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-ElectricityUse_carbon_model">&#182;</a>
        </div>
        <h1>ElectricityUse carbon model</h1>

<p>This model is used by <a href="http://brighterplanet.com">Brighter Planet</a>&rsquo;s carbon emission <a href="http://carbon.brighterplanet.com">web service</a> to estimate the <strong>greenhouse gas emissions of electricity use</strong>.</p>

<h4>Timeframe and date</h4>

<p>The model estimates the emissions that occur during a particular <code>timeframe</code>. To do this it needs to know the <code>date</code> on which the electricity use occurred. For example, if the <code>timeframe</code> is January 2010, a electricity use that occurred on January 5, 2010 will have emissions but a electricity use that occurred on February 1, 2010 will not.</p>

<h4>Calculations</h4>

<p>The final estimate is the result of the <strong>calculations</strong> detailed below. These calculations are performed in reverse order, starting with the last calculation listed and finishing with the <code>emission</code> calculation. Each calculation is named according to the value it returns.</p>

<h4>Methods</h4>

<p>To accomodate varying client input, each calculation may have one or more <strong>methods</strong>. These are listed under each calculation in order from most to least preferred. Each method is named according to the values it requires. If any of these values is not available the method will be ignored. If all the methods for a calculation are ignored, the calculation will not return a value. &ldquo;Default&rdquo; methods do not require any values, and so a calculation with a default method will always return a value.</p>

<h4>Standard compliance</h4>

<p>Each method lists any established calculation standards with which it <strong>complies</strong>. When compliance with a standard is requested, all methods that do not comply with that standard are ignored. This means that any values a particular method requires will have been calculated using a compliant method, because those are the only methods available. If any value did not have a compliant method in its calculation then it would be undefined, and the current method would have been ignored.</p>

<h4>Collaboration</h4>

<p>Contributions to this carbon model are actively encouraged and warmly welcomed. This library includes a comprehensive test suite to ensure that your changes do not cause regressions. All changes should include test coverage for new functionality. Please see <a href="https://github.com/brighterplanet/sniff#readme">sniff</a>, our emitter testing framework, for more information.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">BrighterPlanet</span>
  <span class="k">module</span> <span class="nn">ElectricityUse</span>
    <span class="k">module</span> <span class="nn">ImpactModel</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">decide</span> <span class="ss">:impact</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="ss">:characteristics</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-Emission_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Emission_calculation">&#182;</a>
        </div>
        <h2>Emission calculation</h2>

<p>Returns the <code>emission</code> estimate (<em>kg CO<sub>2</sub>e</em>).
This is the emission produced by generating the electricity used during the <code>timeframe</code>, including transmission and distribution losses.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:carbon</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-Emission_from_date,_emission_factor,_loss_factor,_and_energy'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Emission_from_date,_emission_factor,_loss_factor,_and_energy">&#182;</a>
        </div>
        <h3>Emission from date, emission factor, loss factor, and energy</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from date, emission factor, loss factor and energy&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:date</span><span class="p">,</span> <span class="ss">:emission_factor</span><span class="p">,</span> <span class="ss">:loss_factor</span><span class="p">,</span> <span class="ss">:energy</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="n">date</span> <span class="o">=</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:date</span><span class="o">].</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Date</span><span class="p">)</span> <span class="p">?</span>
                <span class="n">characteristics</span><span class="o">[</span><span class="ss">:date</span><span class="o">]</span> <span class="p">:</span>
                <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">characteristics</span><span class="o">[</span><span class="ss">:date</span><span class="o">].</span><span class="n">to_s</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <ul>
<li>Checks whether the electricity was used during the <code>timeframe</code></li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="k">if</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">include?</span> <span class="n">date</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <ul>
<li>Divides <code>energy</code> (<em>kWh</em>) by (1 &ndash; <code>loss factor</code>) to give total electricity used, including transmission and distribution losses (<em>kWh</em>)</li>
<li>Multiplies by <code>emission factor</code> (<em>kg CO<sub>2</sub>e / kWh</em>) to give emission (<em>kg CO<sub>2</sub>e</em>)</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="n">characteristics</span><span class="o">[</span><span class="ss">:energy</span><span class="o">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:loss_factor</span><span class="o">]</span><span class="p">)</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:emission_factor</span><span class="o">]</span>
              <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <ul>
<li>If the electricity was not used during the <code>timeframe</code>, <code>emission</code> is zero</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="mi">0</span>
              <span class="k">end</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-Emission_factor_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Emission_factor_calculation">&#182;</a>
        </div>
        <h2>Emission factor calculation</h2>

<p>Returns the grid average emission factor of the area where the electricity was used (<em>kg CO<sub>2</sub> / kWh</em>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:emission_factor</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-Emission_factor_from_eGRID_subregion'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Emission_factor_from_eGRID_subregion">&#182;</a>
        </div>
        <h3>Emission factor from eGRID subregion</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from eGRID subregion&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:egrid_subregion</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Looks up the emission factor of the <code>eGRID subregion</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:egrid_subregion</span><span class="o">].</span><span class="n">electricity_emission_factor</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-Loss_factor_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Loss_factor_calculation">&#182;</a>
        </div>
        <h2>Loss factor calculation</h2>

<p>Returns the average transmission and distribution loss factor for the area where the electricity was used.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:loss_factor</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-Loss_factor_from_eGRID_region'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Loss_factor_from_eGRID_region">&#182;</a>
        </div>
        <h3>Loss factor from eGRID region</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from eGRID region&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:egrid_region</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Looks up the loss factor of the <code>eGRID region</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:egrid_region</span><span class="o">].</span><span class="n">loss_factor</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-eGRID_region_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-eGRID_region_calculation">&#182;</a>
        </div>
        <h2>eGRID region calculation</h2>

<p>Returns the <a href="http://data.brighterplanet.com/egrid_regions">eGRID region</a> where the electricity was used.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:egrid_region</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-eGRID_region_from_eGRID_subregion'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-eGRID_region_from_eGRID_subregion">&#182;</a>
        </div>
        <h3>eGRID region from eGRID subregion</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from eGRID subregion&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:egrid_subregion</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Looks up the <a href="http://data.brighterplanet.com/egrid_regions">eGRID region</a> in which the <code>eGRID subregion</code> is located.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:egrid_subregion</span><span class="o">].</span><span class="n">egrid_region</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-eGRID_subregion_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-eGRID_subregion_calculation">&#182;</a>
        </div>
        <h2>eGRID subregion calculation</h2>

<p>Returns the <a href="http://data.brighterplanet.com/egrid_subregions">eGRID subregion</a> where the electricity was used.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:egrid_subregion</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-eGRID_subregion_from_zip_code'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-eGRID_subregion_from_zip_code">&#182;</a>
        </div>
        <h3>eGRID subregion from zip code</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from zip code&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:zip_code</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Looks up the <a href="http://data.brighterplanet.com/egrid_subregions">eGRID subregion</a> in which the <code>zip code</code> is located.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:zip_code</span><span class="o">].</span><span class="n">egrid_subregion</span>
            <span class="k">end</span>
            </pre></div>
      </td>
    </tr>
    <tr id='section-eGRID_subregion_from_default'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-eGRID_subregion_from_default">&#182;</a>
        </div>
        <h4>eGRID subregion from default</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Uses the average of all <a href="http://data.brighterplanet.com/egrid_subregions">eGRID subregion</a>, weighted by electricity generation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="no">EgridSubregion</span><span class="o">.</span><span class="n">find_by_abbreviation</span> <span class="s1">&#39;US&#39;</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-Energy_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Energy_calculation">&#182;</a>
        </div>
        <h2>Energy calculation</h2>

<p>Returns the electricity used (<em>kWh</em>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:energy</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-Energy_use_from_client_input'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Energy_use_from_client_input">&#182;</a>
        </div>
        <h3>Energy use from client input</h3>

<p>Uses the client-input <code>energy</code> (<em>kWh</em>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            </pre></div>
      </td>
    </tr>
    <tr id='section-Energy_from_default'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Energy_from_default">&#182;</a>
        </div>
        <h3>Energy from default</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Uses the 2008 U.S. <a href="http://www.eia.doe.gov/ask/electricity_faqs.asp#electricity_use_home">annual household average electricity use</a> (<em>kWh</em>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="mi">11_040</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-Date_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Date_calculation">&#182;</a>
        </div>
        <h2>Date calculation</h2>

<p>Returns the <code>date</code> on which the electricity was used.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">committee</span> <span class="ss">:date</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-Date_from_client_input'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Date_from_client_input">&#182;</a>
        </div>
        <h3>Date from client input</h3>

<p>Uses the client-input <code>date</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            </pre></div>
      </td>
    </tr>
    <tr id='section-Date_from_timeframe'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Date_from_timeframe">&#182;</a>
        </div>
        <h3>Date from timeframe</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="n">quorum</span> <span class="s1">&#39;from timeframe&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Assumes the electricity was used on the first day of the <code>timeframe</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="n">timeframe</span><span class="o">.</span><span class="n">from</span>
            <span class="k">end</span>
          <span class="k">end</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-Zip_code_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Zip_code_calculation">&#182;</a>
        </div>
        <h2>Zip code calculation</h2>

<p>Returns the <a href="http://data.brighterplanet.com/zip_codes">zip code</a> where the electricity was used.</p>

<h3>Zip code from client input</h3>

<p>Uses the client-input <a href="http://data.brighterplanet.com/zip_codes">zip code</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          </pre></div>
      </td>
    </tr>
    <tr id='section-Timeframe_calculation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Timeframe_calculation">&#182;</a>
        </div>
        <h2>Timeframe calculation</h2>

<p>Returns the <code>timeframe</code> during which to calculate emissions.</p>

<h3>Timeframe from client input</h3>

<p>Uses the client-input <code>timeframe</code>.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
